#!/bin/bash
set -euo pipefail

# ---- env for templates ----
export DOCKER_HOSTNAME
DOCKER_HOSTNAME="$(hostname)"

export DOCKER_IP
DOCKER_IP="$(ping -q -c 1 -t 1 "$DOCKER_HOSTNAME" 2>/dev/null | grep PING | sed -r 's/^[^(]*[(]([^)]*)[)].*$/\1/' || true)"

export DOCKER_UID
DOCKER_UID="$(id -u "$USER")"

export DOCKER_GID
DOCKER_GID="$(id -g "$USER")"

export DOCKER_UNAME="$USER"
export DOCKER_HOME="$HOME"
export COMPOSE_HTTP_TIMEOUT=600

# ---- run build hooks for build/up ----
is_build=false
for arg in "$@"; do
  if [[ "$arg" == "build" || "$arg" == "up" ]]; then
    is_build=true
    break
  fi
done

if $is_build; then
  while IFS= read -r -d '' HOOK; do
    "./$HOOK" || { echo "Error of build hook '$HOOK' execution" >&2; exit 1; }
  done < <(find .j-docker-compose/build-hooks/ -name '*.sh' -print0 2>/dev/null || true)
fi

# ---- parse args: find -f template and -o output (render-only) and -D dict ----
template_file=""
output_file=""
dict_file=""

compose_args=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -f|--file)
      template_file="$2"
      shift 2
      ;;
    -o|--output)
      output_file="$2"
      shift 2
      ;;
    -D|--dict)
      dict_file="$2"
      shift 2
      ;;
    *)
      compose_args+=("$1")
      shift
      ;;
  esac
done

if [[ -z "$template_file" ]]; then
  echo "ERROR: -f/--file is required" >&2
  exit 2
fi

# ---- choose default output if not provided ----
if [[ -z "$output_file" ]]; then
  base="$(basename "$template_file")"
  # remove trailing .j2 if present
  base="${base%.j2}"
  mkdir -p build
  output_file="build/$base"
fi

if command -v podman-compose &>/dev/null; then
  export DOCKER_IS_PODMAN=1
else
  export DOCKER_IS_PODMAN=0
fi

# ---- render via j2-cli ----
if ! command -v j2 >/dev/null 2>&1; then
  echo "ERROR: 'j2' (j2cli) is not installed or not in PATH" >&2
  exit 127
fi

mkdir -p "$(dirname "$output_file")"

if [[ -n "$dict_file" ]]; then
  # j2 template datafile -o out
  j2 "$template_file" "$dict_file" --format=json -o "$output_file"
else
  # j2 template -o out  (only env vars used)
  j2 "$template_file" --format=env -o "$output_file"
fi

# ---- run docker compose using rendered file ----
# use podman-compose if it is available (for solve some CDI options compatibility)
if (( DOCKER_IS_PODMAN )); then
  exec podman-compose -f "$output_file" "${compose_args[@]}"
else
  exec docker-compose -f "$output_file" "${compose_args[@]}"
fi
